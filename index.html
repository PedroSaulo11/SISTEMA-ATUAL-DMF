<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>DMF Enterprise - Fluxo Financeiro v2.0</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assistant.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<div id="loginSection" class="login-screen">
    <div class="login-box">
        <h2 class="login-title">DMF Empreendimentos</h2>
        <div class="form-group">
            <input type="text" id="loginInput" placeholder="Usuário ou Email" class="styled-input">
            <input type="password" id="loginPass" placeholder="Senha" class="styled-input">
        </div>
        <button id="btnLogin" class="btn btn-primary btn-full">Acessar Sistema</button>
        <p class="login-subtitle">Acesso restrito a colaboradores autorizados.</p>
    </div>
</div>

<div id="appSection" class="app-wrapper hidden">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>DMF FLUXO</h3>
            <p id="userRoleBadge" class="user-role-badge"></p>
        </div>
        <nav class="sidebar-nav">
            <button class="btn-side active" data-nav="dashboard">Dashboard</button>
            <button class="btn-side" data-nav="payments">Fluxo de Pagamentos</button>
            <button class="btn-side" data-nav="audit">Logs de Auditoria</button>
            <button id="adminMenu" class="btn-side hidden" data-nav="admin">Administração</button>
            <button class="btn-side" data-nav="assistente">Assistente</button>
            <button class="btn-side" data-nav="cobli">Cobli</button>
        </nav>
        <button id="btnLogout" class="btn btn-logout">Sair</button>
    </aside>

    <main class="main-content">
        <section id="dashboard" class="view">
            <div class="card">
                <h2>Visão Geral Financeira</h2>
                <div class="stats-grid">
                    <div class="stat-item">Total Bruto<br><span id="totalBruto">R$ 0,00</span></div>
                    <div class="stat-item">Assinados<br><span id="totalAssinados">0</span></div>
                    <div class="stat-item">Aguardando<br><span id="totalPendentes">0</span></div>
                </div>
                <canvas id="financeChart" height="100"></canvas>
            </div>
        </section>

        <section id="payments" class="view hidden">
            <div class="card">
                <div class="flex-header">
                    <h2>Fluxo de Pagamentos</h2>
                    <div class="actions">
                        <button id="btnClearPayments" class="btn btn-danger">Remover Todo Fluxo</button>
                        <button id="btnExportPayments" class="btn btn-ghost">Exportar XLSX</button>
                        <button id="btnImportPayments" class="btn btn-primary">Importar Conta Azul</button>
                        <button id="btnRefreshPayments" class="btn btn-ghost">Recarregar do servidor</button>
                        <button id="btnAddPayment" class="btn btn-primary">Adicionar Pagamento</button> <!-- ALTERADO -->
                    </div>
                </div>
                <div id="flowSyncStatus" class="flow-sync-status">Sincronizando com o servidor...</div>
                <input type="file" id="fileInput" accept=".xlsx" class="hidden">
                
                <div class="admin-tabs payments-tabs">
                    <button class="tab-btn active" data-payments-tab="current">Fluxo Atual</button>
                    <button class="tab-btn" data-payments-tab="history">Fluxos Anteriores</button>
                </div>

                <div id="paymentsCurrentTab" class="payments-tab-content">
                    <div class="data-table-wrapper data-table-spaced">
                        <table id="paymentsTable">
                            <thead>
                                <tr>
                                    <th>Fornecedor</th>
                                    <th>Data</th>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Centro de Custo</th>
                                    <th>Categoria</th>
                                    <th>Status</th>
                                    <th>Assinatura</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsBody"></tbody>
                        </table>
                    </div>
                    <div id="companyTotals" class="company-totals">
                        <div class="company-totals-header">Totais por Empresa</div>
                        <div id="companyTotalsBody" class="company-totals-body"></div>
                    </div>
                </div>

                <div id="paymentsHistoryTab" class="payments-tab-content hidden">
                    <div class="flex-header">
                        <h3>Fluxos Anteriores</h3>
                        <div class="actions">
                            <button id="btnArchiveFlow" class="btn btn-ghost">Enviar para Fluxos Anteriores</button>
                            <button id="btnRefreshArchives" class="btn btn-ghost">Recarregar Fluxos</button>
                        </div>
                    </div>
                    <div id="flowArchivesList" class="flow-archives-list"></div>
                    <div id="flowArchiveDetail" class="flow-archive-detail"></div>
                </div>
            </div>
        </section>

        <section id="audit" class="view hidden">
            <div class="card">
                <h2>Histórico de Operações</h2>
                <div class="admin-tabs audit-tabs">
                    <button class="tab-btn active" data-audit-tab="logs">Logs</button>
                    <button class="tab-btn" data-audit-tab="signature">Pesquisar Assinatura</button>
                </div>
                <div id="auditContent">
                    <div id="auditLogsTab" class="audit-tab-content">
                        <table id="auditLogTable">
                            <thead>
                                <tr><th>Data/Hora</th><th>Usuário</th><th>Ação</th><th>Detalhes</th></tr>
                            </thead>
                            <tbody id="auditBody"></tbody>
                        </table>
                    </div>
                    <div id="auditSignatureTab" class="audit-tab-content hidden">
                        <div class="form-group">
                            <label for="signatureSearchInput">ID da Assinatura:</label>
                            <input type="text" id="signatureSearchInput" class="styled-input" placeholder="Cole o ID da assinatura">
                        </div>
                        <button id="signatureSearchButton" class="btn btn-primary">Pesquisar</button>
                        <div id="signatureSearchResult" class="signature-search-result"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="admin" class="view hidden">
            <div class="card">
                <h2>Administração</h2>
                <div class="admin-tabs">
                    <button class="tab-btn active" data-admin-tab="users">Gerenciar Usuários</button>
                    <button class="tab-btn" data-admin-tab="roles">Gerenciar Cargos</button>
                </div>
                <div id="adminContent">
                    <div id="usersTab" class="admin-tab-content">
                        <h3>Usuários do Sistema</h3>
                        <button id="btnCreateUser" class="btn btn-primary">Criar Usuário</button>
                        <div id="userGrid"></div>
                    </div>
                    <div id="rolesTab" class="admin-tab-content hidden">
                        <h3>Cargos e Permissões</h3>
                        <button id="btnCreateRole" class="btn btn-primary">Criar Novo Cargo</button>
                        <div id="rolesGrid"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="assistente" class="view hidden">
            <div class="card">
                <h2>Assistente Virtual</h2>
                <div id="chatContainer" class="chat-container">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Digite sua pergunta..." class="chat-input">
                        <button id="chatSendBtn" class="btn btn-primary chat-send-btn">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="cobli" class="view hidden">
            <div class="card">
                <h2>Painel Cobli</h2>
                <div class="stats-grid">
                    <div class="stat-item">Veículos Cadastrados<br><span id="veiculosCadastrados">0</span></div>
                    <div class="stat-item">Locais de Interesse<br><span id="locaisInteresse">0</span></div>
                    <div class="stat-item">Eventos Velocidade Veículo<br><span id="eventosVelocidadeVeiculo">0</span></div>
                    <div class="stat-item">Eventos Velocidade Via<br><span id="eventosVelocidadeVia">0</span></div>
                    <div class="stat-item">Rotas com Veículo<br><span id="rotasComVeiculo">0</span></div>
                    <div class="stat-item">Rotas sem Veículo<br><span id="rotasSemVeiculo">0</span></div>
                    <div class="stat-item">Produtividade Média Frota<br><span id="produtividadeMedia">0%</span></div>
                </div>
                <div id="mapContainer" class="map-container"></div>
            </div>
        </section>
    </main>
</div>

<!-- Modal for Creating User -->
<div id="createUserModal" class="modal">
    <div class="modal-content">
        <span class="close" data-close-modal="createUserModal">&times;</span>
        <h3>Criar Novo Usuário</h3>
        <form id="createUserForm">
            <div class="form-group">
                <label for="userName">Nome:</label>
                <input type="text" id="userName" name="userName" required>
            </div>
            <div class="form-group">
                <label for="userUsername">Usuário:</label>
                <input type="text" id="userUsername" name="userUsername" required>
            </div>
            <div class="form-group">
                <label for="userEmail">Email:</label>
                <input type="email" id="userEmail" name="userEmail" required>
            </div>
            <div class="form-group">
                <label for="userPassword">Senha:</label>
                <input type="password" id="userPassword" name="userPassword" required>
            </div>
            <div class="form-group">
                <label for="userRole">Cargo:</label>
                <select id="userRole" name="userRole" required>
                    <option value="">Selecione um cargo</option>
                    <option value="admin">Admin</option>
                    <option value="gestor">Gestor</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Criar Usuário</button>
        </form>
    </div>
</div>

<!-- Modal for Creating Role -->
<div id="createRoleModal" class="modal">
    <div class="modal-content">
        <span class="close" data-close-modal="createRoleModal">&times;</span>
        <h3>Criar Novo Cargo</h3>
        <form id="createRoleForm">
            <div class="form-group">
                <label for="roleName">Nome do Cargo:</label>
                <input type="text" id="roleName" name="roleName" required>
            </div>
            <div class="form-group">
                <label>Permissões:</label>
                <div class="permissions">
                    <label>
                        Usuário pode adicionar novos Pagamentos?
                        <select id="rolePermAddPayments">
                            <option value="no">Não</option>
                            <option value="yes">Sim</option>
                        </select>
                    </label>
                    <label>
                        Usuário pode assinar Fluxo de Pagamentos?
                        <select id="rolePermSignPayments">
                            <option value="no">Não</option>
                            <option value="yes">Sim</option>
                        </select>
                    </label>
                    <label>
                        Usuário Pode Ver a aba Administração?
                        <select id="rolePermViewAdmin">
                            <option value="no">Não</option>
                            <option value="yes">Sim</option>
                        </select>
                    </label>
                    <label>
                        Usuário pode Acessar a Aba Logs de Auditoria?
                        <select id="rolePermAccessAudit">
                            <option value="no">Não</option>
                            <option value="yes">Sim</option>
                        </select>
                    </label>
                    <label>
                        Usuário Pode Importar Fluxo de Pagamentos?
                        <select id="rolePermImportPayments">
                            <option value="no">Não</option>
                            <option value="yes">Sim</option>
                        </select>
                    </label>
                    <label>
                        Usuário Pode Exportar Fluxo de Pagamentos?
                        <select id="rolePermExportPayments">
                            <option value="no">Não</option>
                            <option value="yes">Sim</option>
                        </select>
                    </label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Criar Cargo</button>
        </form>
    </div>
</div>

<!-- Modal for Editing User -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <span class="close" data-close-modal="editUserModal">&times;</span>
        <h3>Editar Usuário</h3>
        <form id="editUserForm">
            <input type="hidden" id="editUserId" name="editUserId">
            <div class="form-group">
                <label for="editUserName">Nome:</label>
                <input type="text" id="editUserName" name="editUserName" required>
            </div>
            <div class="form-group">
                <label for="editUserUsername">Usuário:</label>
                <input type="text" id="editUserUsername" name="editUserUsername" required>
            </div>
            <div class="form-group">
                <label for="editUserEmail">Email:</label>
                <input type="email" id="editUserEmail" name="editUserEmail" required>
            </div>
            <div class="form-group">
                <label for="editUserRole">Cargo:</label>
                <select id="editUserRole" name="editUserRole" required>
                    <option value="admin">Admin</option>
                    <option value="gestor">Gestor</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Atualizar Usuário</button>
        </form>
    </div>
</div>

<!-- Modal for Changing Password -->
<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <span class="close" data-close-modal="changePasswordModal">&times;</span>
        <h3>Trocar Senha</h3>
        <p>Alterando senha para: <strong id="changePasswordUserName"></strong></p>
        <form id="changePasswordForm">
            <input type="hidden" id="changePasswordUserId" name="changePasswordUserId">
            <div class="form-group">
                <label for="newPassword">Nova Senha:</label>
                <input type="password" id="newPassword" name="newPassword" required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirmar Senha:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Alterar Senha</button>
        </form>
    </div>
</div>

<!-- Modal: Adicionar Pagamento --> <!-- ALTERADO -->
<div id="addPaymentModal" class="modal"> <!-- ALTERADO -->
  <div class="modal-content">
    <span class="close" data-close-modal="addPaymentModal">&times;</span>
    <h3>Adicionar Pagamento</h3>
    <form id="addPaymentForm"> <!-- ALTERADO -->
      <div class="form-group">
        <label for="addFornecedor">Fornecedor:</label>
        <input type="text" id="addFornecedor" name="fornecedor" required> <!-- ALTERADO -->
      </div>
      <div class="form-group">
        <label for="addData">Data:</label>
        <input type="date" id="addData" name="data" required> <!-- ALTERADO -->
      </div>
      <div class="form-group">
        <label for="addDescricao">Descrição:</label>
        <input type="text" id="addDescricao" name="descricao"> <!-- ALTERADO -->
      </div>
      <div class="form-group">
        <label for="addValor">Valor:</label>
        <input type="text" id="addValor" name="valor" placeholder="Ex.: 1.234,56" required> <!-- ALTERADO -->
      </div>
      <div class="form-group">
        <label for="addCentro">Centro de Custo:</label>
        <input type="text" id="addCentro" name="centro" placeholder="Geral" required list="centrosDataList"> <!-- ALTERADO -->
        <datalist id="centrosDataList"></datalist> <!-- ALTERADO -->
      </div>
      <button type="submit" class="btn btn-primary">Adicionar</button> <!-- ALTERADO -->
    </form>
  </div>
</div>

<script src="script.js"></script>
<script src="assistant.js"></script>
</body>
</html>
